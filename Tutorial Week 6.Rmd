---
title: "Rural Windfall or a New Resource Curse? Coca, Income, and Civil Conflict in Colombia"
subtitle: "Based on Angrist & Kugler (2008)"
author:
  - Maximilian Birkle
  - Daniel Lehmann
  - Henry Lucas
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true
    fig_caption: true
    keep_tex: false
    latex_engine: xelatex
  github_document:
    toc: true
    html_preview: true
---

```{r setup, include=TRUE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      fig.width = 10, fig.height = 6)
# Setup 
if (!require(haven)) install.packages("haven")
library (haven)
if (!require(dplyr)) install.packages("dplyr")
library(dplyr)
if (!require(foreign)) install.packages("foreign")
library(foreign)
if (!require(plm)) install.packages("plm")
library(plm)
if (!require(stargazer)) install.packages("stargazer")
library(stargazer)
if (!require(ggplot2)) install.packages("ggplot2")
library (ggplot2)
if (!require(sandwich)) install.packages("sandwich")
library (sandwich)
if (!require(lmtest)) install.packages("lmtest")
library (lmtest)
if (!require(tidyverse)) install.packages("tidyverse")
library (tidyverse)
if (!require(BART)) install.packages("BART")
library (BART)
if (!require(grf)) install.packages("grf")
library (grf)
if (!require(car)) install.packages("car")
library (car)


# Load Data and take a look at the dataset
dta <- read_delim("data00_AngristKugler.tab", delim = "\t")
```

---

# Q1. Setup and Data Construction

**Tasks:**

1. Create `grow` variable (1 if `dep_ocu` $\in \{13, 18, 19, 50, 52, 86, 95, 97, 99\}$, 0 otherwise)

```{r q1-data-setup}

# Creating a new variable grow
department_list <- c(13, 18, 19, 50, 52, 86, 95, 97, 99)

dta <- dta %>% 
  mutate(grow = ifelse(dep_ocu %in% department_list, 1, 0))
```

2. Subset data to years 1991, 1992, 1993 and 1996, 1997, 1998

```{r}

# Subsetting the dataset to years 1991 - 1993 and 1996 - 1998
dta_subset <- dta %>% 
  filter(year %in% c(1991, 1992, 1993, 1996, 1997, 1998))

```

3. Create `after` variable (1 if year $\in \{1996, 1997, 1998\}$, 0 otherwise)

```{r}

# We create a variable called after with 1 for years 1996 - 1998
dta_subset <- dta_subset %>% 
  mutate(after = ifelse(year %in% c(1996, 1997, 1998), 1, 0))
```

4. Create `growafter` variable (`grow` $\times$ `after`)

```{r}

# Creating growafter variable (grow * after)
dta_subset <- dta_subset %>% 
  mutate(growafter = grow * after)

dta_subset %>% 
  count(grow, after, growafter)
```

5. Create outcome variable: $\log\left(\frac{\text{populati}+1}{\text{violent}+1}\right)$

```{r}

# Create outcome variable

dta_subset <- dta_subset %>% 
  mutate(outcome = log((violent + 1) / (populati + 1)))
```

---

# Q2. Visualizing Violence Before and After

**Tasks:**

1. Create density plots for non-growing vs. growing regions, before vs. after
2. Extend to $2 \times 2$ grid by gender (men: `sex=1`, women: `sex=2`)
3. Interpret: Evidence of shifts in violence? Different by gender?

```{r q2-density-plots-simple}

# Density plots: Non-growing vs. Growing regions

density_plot <- dta_subset %>% 
  mutate(
    period = factor(after, levels = c(0, 1), labels = c("Before (1991-93)", "After (1996-98)")),
    region_type = factor(grow, levels = c(0, 1), labels = c("Non-Growing Region", "Growing Region")),
    gender = factor(sex, levels = c(1, 2), labels = c("Men", "Women"))
  )


density_plot %>%
  ggplot(aes(x = outcome, fill = period, color = period)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ region_type) +
  labs(title = "Logged per-capita violent death rate distribution: Before vs After by Region Type",
       x = "Number of Violent Deaths",
       y = "Density") +
  theme_bw()

```

```{r q2-density-plots-gender}
# 2x2 grid: Top=men, Bottom=women; Left=non-growing, Right=growing

density_plot %>%
  filter(!is.na(gender)) %>%
  ggplot(aes(x = outcome, fill = period, color = period)) +
  geom_density(alpha = 0.5) +
  facet_grid(gender ~ region_type) +
  labs(title = "Logged per-capita violent death rate distribution by Gender and Region Type",
       x = "Number of Violent Deaths",
       y = "Density") +
  theme_bw()
```

**Interpretation:**

The evidence indicates a significant shift in violence following the air-bridge disruption, with the effect being highly specific to both region and gender. For the treatment group (**coca-growing regions**), there was a slight increase in the per-capita violent death rate among men. In contrast, the control group (**non-growing regions**) showed no meaningful change for either gender, which suggests that the increase in violence was not due to a nationwide trend. Furthermore, the pattern seems to be strongly gendered; the effect on women in the treatment group was minimal compared to a much larger effect on men. This suggests that the impact of the coca boom on violence was almost exclusively concentrated among the male population, who seem to have been the primary participants in the conflict.

---

# Q3. Age-Specific Effects

**Task:** For coca-growing regions only, plot the change in outcome (after - before) by age group.

```{r q3-age-effects}
# Calculate mean difference by age for growing regions only

age_effects <- dta_subset %>%
  filter(grow == 1) %>%
  group_by(age, after) %>%
  summarise(mean_outcome = mean(outcome, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = after, values_from = mean_outcome, names_prefix = "period_") %>%
  mutate(change = period_1 - period_0)

# Plot age-specific effects
age_effects %>%
  ggplot(aes(x = age, y = change)) +
  geom_line(color = "blue", size = 1) +
  geom_point(color = "blue", size = 2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Change in Logged per-capita Violent Death Rate by Age (Coca-Growing Regions)",
       x = "Age",
       y = "Change in Outcome (After - Before)") +
  theme_bw()

```

**Interpretation:**

This plot illustrates how the average violence rate changes for each age group by calculating the difference between the average violence rate for an age group after the air-bridge disruption and the average violence rate for that same group before the disruption. Clearly, the plot shows that the effect varies dramatically across different age groups, with a heavy concentration in certain age brackets. The increase in conflict and violence seems to have disproportionately affected individuals of fighting age, as can be seen from the peaks in the graph between the ages of 17 and 22. Additionally, younger adolescents around the age of 10 seem to have been particularly involved in violent activities, resulting in a much higher death rate after the air disruption. However, it is important to note that, for a few age groups — especially those around 15 years old — the rate of violence decreased after the air disruption.

---

# Q4. Testing the Parallel Trends Assumption (Pre-Treatment)

**Tasks:**

1. Use pre-treatment years (1990-1993)
2. Estimate: outcome $= \alpha + \beta \cdot \text{year} + \gamma \cdot \text{grow} + \delta \cdot (\text{grow} \times \text{year}) + u$
3. Test if `grow` $\times$ `year` interactions are jointly zero (year as linear and categorical)
4. Create graph of average outcome by year and group

```{r q4-prepare-data}
# Subset to pre-treatment years (1990-1993)
dta_pretreatment <- dta %>%
  filter(year %in% c(1990, 1991, 1992, 1993)) %>%
  mutate(grow = ifelse(dep_ocu %in% department_list, 1, 0),
         outcome = log((violent + 1) / (populati + 1)))
```

```{r q4-parallel-trends-linear}
# Model with year as linear
year_linear <- lm(outcome ~ year + grow + year:grow, data = dta_pretreatment)

summary(year_linear)
```

```{r q4-parallel-trends-categorical}
# Model with year as categorical (factor)
year_factor <- lm(outcome ~ factor(year) + grow + factor(year):grow, data = dta_pretreatment)

summary(year_factor)
```

```{r q4-joint-test}
# Test if grow×year interactions are jointly zero
linearHypothesis(year_factor, matchCoefs(year_factor, ":grow"))
```

```{r q4-visual-trends}
# Graph: Average outcome by year and group
dta_pretreatment %>%
  group_by(year, grow) %>%
  summarise(mean_outcome = mean(outcome, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = year, y = mean_outcome, color = factor(grow))) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Pre-treatment Trends in Violence by Region Type",
    subtitle = "Checking Parallel Trends (1990–1993)",
    x = "Year",
    y = "Mean Logged per-capita Violent Death Rate",
    color = "Coca-growing Region"
  ) +
  theme_bw()
```

**Interpretation:**

To assess the validity of the parallel trend assumption, we focused on the pre-treatment period from 1990 to 1993. Both regression models formally test this parallel trends assumption by examining if the pre-treatment trends in violence are statistically different between the coca-growing regions and non-growing regions. The first model simplifies our analysis by assuming that time follows a linear trend. The key coefficient here is the interaction term **year:grow**, which measures the difference in the slopes of trend lines for the two groups. The p-value for this term is 0.99, which indicates that there is no statistically significant difference between the slopes. 
The second model offers a more flexible, year-by-year analysis by checking if the gap in violence between the two groups changed in any year from 1991 to 1993 compared to the baseline year of 1990, instead of assuming a straight line. The additional, joint F-test on these interactions yields a p-value of 1 which is why we fail to reject the null hypothesis $H_0$ that the pre-treatment trends are perfectly parallel. This result is crucial because it validates the use of non-growing regions as a credible counterfactual. It gives us confidence that any divergence between the groups after the disruption is due to the coca boom itself, rather than pre-existing differences in trends.

---

# Q5. Placebo DiD Test 

**Tasks:**

1. Create `placebo_after` (1 if year $= 1992$ or $1993$, 0 if year $= 1990$ or $1991$)
2. Estimate placebo DiD model
3. Interpret `placebo_after` $\times$ `grow` coefficient

```{r q5-placebo-data}
# Subset and create placebo variables
dta_placebo <- dta %>%
  filter(year %in% c(1990, 1991, 1992, 1993)) %>%
  mutate(
    grow = ifelse(dep_ocu %in% department_list, 1, 0),
    outcome = log((violent + 1) / (populati + 1)),
    placebo_after = ifelse(year %in% c(1992, 1993), 1, 0)
  )
```

```{r q5-placebo-regression}
# Estimate placebo DiD model
placebo_did <- lm(outcome ~ placebo_after + grow + placebo_after:grow, data = dta_placebo)
summary(placebo_did)
```

**Interpretation:**

[Should the placebo effect be significant? What would significance suggest?]

---

# Q6. Covariate Balance at Time 0

**Task:** Compare treatment and control regions on `age`, `sex`, and `populati` using pre-treatment data.

```{r q6-balance-table}
# Create balance table
dta_balance <- dta_subset %>%
  filter(after == 0)

balance_table <- dta_balance %>%
  group_by(grow) %>%
  summarise(
    mean_age = mean(age, na.rm = TRUE),
    mean_sex = mean(sex, na.rm = TRUE),
    mean_pop = mean(populati, na.rm = TRUE),
    .groups = "drop"
  )

balance_table
```

```{r q6-balance-plot}
# Optional: Standardized difference plot

```

**Discussion:**

[Why is covariate balance critical? What would imbalance imply?]

---

# Q7. Why Covariate Balance Matters

**Discussion Questions:**

1. If covariates are balanced at time 0, what does this imply about confounding?
2. What role do these variables play after assignment?
3. If violence trends already differ before treatment, how might this bias DiD?

[Your answers here]

---

# Q8. Covariate Timing and Post-Treatment Bias

**Discussion Questions:**

1. Should we include covariates from time 0, time 1, or both?
2. What happens if you include a covariate measured after treatment?
3. When might adjusting for post-treatment variables be appropriate?

[Your answers here]

---

# Q9. Computing the DiD Estimate

**Task:** Compute manual DiD estimate.

```{r q9-manual-did}
# Mean difference (after - before) for grow=1 and grow=0
did_table <- dta_subset %>%
  group_by(grow, after) %>%
  summarise(mean_outcome = mean(outcome, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = after, values_from = mean_outcome, names_prefix = "time") %>%
  mutate(diff = time1 - time0)

# DiD estimate: subtract the two
did_estimate <- diff(did_table$diff)
did_estimate

```

**Interpretation:**

[Why is DiD preferable to simple before-after comparison?]

---

# Q10. Regression Form of DiD

**Tasks:**

1. Estimate: outcome $= \beta_0 + \beta_1 \cdot \text{after} + \beta_2 \cdot \text{grow} + \beta_3 \cdot (\text{after} \times \text{grow}) + u$
2. Report $\beta_3$ and p-value
3. Show analytically that $\beta_3$ equals the manual DiD estimate

```{r q10-did-regression}
# DiD regression model
did <- lm(outcome ~ after + grow + after:grow, data = dta_subset)
summary(did)
```

**Interpretation:**

[What does $\beta_3$ tell us about the causal effect?]

**Analytical proof:**

[Show that $\beta_3 = (\bar{Y}_{1,1} - \bar{Y}_{1,0}) - (\bar{Y}_{0,1} - \bar{Y}_{0,0})$]

---

# Q11. Adding Covariates

**Task:** Estimate three models and compare.

```{r q11-model1}
# Model 1: outcome ~ grow + after + growafter
cov_did1 <- lm(outcome ~ after + grow + after:grow, data = dta_subset)
```

```{r q11-model2}
# Model 2: Add age and sex
cov_did2 <- lm(outcome ~ after + grow + after:grow + age + sex, data = dta_subset)
```

```{r q11-model3}
# Model 3: Add age, sex, and populati
cov_did3 <- lm(outcome ~ after + grow + after:grow + age + sex + populati, data = dta_subset)
```

```{r q11-comparison}
# Compare models
stargazer(cov_did1, cov_did2, cov_did3,      # List your models
          type = "text",                   # Output type: "text", "html", or "latex"
          title = "Regression Results: The Effect of Treatment on Outcome",
          align = TRUE,                    # Aligns numbers on decimal points
          dep.var.labels = "Outcome",      # A clean name for the dependent variable
          column.labels = c("Base Model", "Adds Demographics", "Full Model"),
          covariate.labels = c("After Treatment", "Treatment Group (Grow)", "Age",
                               "Sex", "Population", "Interaction: After x Grow"),
          notes = "Standard errors are in parentheses.",
          notes.align = "l")
```

**Discussion:**

[Does $\beta_3$ change? Do covariates matter? Which specification is most credible?]

---

# Q12. Interpretation and Reflection

**Summary:**

1. Did violence increase or decrease after the air-bridge disruption?
2. Does the evidence support a "resource-curse" interpretation?
3. What are the remaining identification threats?

[Your final interpretation here]
