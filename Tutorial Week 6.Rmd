---
title: "Rural Windfall or a New Resource Curse? Coca, Income, and Civil Conflict in Colombia"
subtitle: "Based on Angrist & Kugler (2008)"
author:
  - Maximilian Birkle
  - Daniel Lehmann
  - Henry Lucas
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true
    fig_caption: true
    keep_tex: false
    latex_engine: xelatex
  github_document:
    toc: true
    html_preview: true
---

```{r setup, include=TRUE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      fig.width = 10, fig.height = 6)
# Setup 
library(tidyverse)
library(haven)    
library(knitr)    
library(kableExtra)
library(broom)     
library(lmtest)    
library(car)       
library(gridExtra) 


# Load Data and take a look at the dataset
data <- read_delim("data00_AngristKugler.tab", delim = "\t")
glimpse(data)
```

---

# Q1. Setup and Data Construction

**Tasks:**

1. Create `grow` variable (1 if `dep_ocu` $\in \{13, 18, 19, 50, 52, 86, 95, 97, 99\}$, 0 otherwise)

```{r q1-data-setup}

# Creating a new variable grow
department_list <- c(13, 18, 19, 50, 52, 86, 95, 97, 99)

data <- data %>% 
  mutate(grow = ifelse(dep_ocu %in% department_list, 1, 0))
```

2. Subset data to years 1991, 1992, 1993 and 1996, 1997, 1998

```{r}

# Subsetting the dataset to years 1991 - 1993 and 1996 - 1998
data_subset <- data %>% 
  filter(year %in% c(1991, 1992, 1993, 1996, 1997, 1998))

```

3. Create `after` variable (1 if year $\in \{1996, 1997, 1998\}$, 0 otherwise)

```{r}

# We create a variable called after with 1 for years 1996 - 1998
data_subset <- data_subset %>% 
  mutate(after = ifelse(year %in% c(1996, 1997, 1998), 1, 0))
```

4. Create `growafter` variable (`grow` $\times$ `after`)

```{r}

# Creating growafter variable (grow * after)
data_subset <- data_subset %>% 
  mutate(growafter = grow * after)

# Confirm that both are coded correctly
data_subset %>% 
  filter(grow == 1) %>% 
  distinct(dep_ocu) %>% 
  arrange(dep_ocu)


data_subset %>% 
  count(grow, after, growafter)

# First Table: Grow takes the value of 1 only for defined departments.
# Second Table: 'growafter' only takes the value of 1 if grow and after are 1.
```

5. Create outcome variable: $\log\left(\frac{\text{populati}+1}{\text{violent}+1}\right)$

```{r}

# Create outcome variable (it makes more sense if it is death over population) 
data_subset <- data_subset %>% 
  mutate(outcome = log((violent + 1) / (populati + 1)))
```


---

# Q2. Visualizing Violence Before and After

**Tasks:**

1. Create density plots for non-growing vs. growing regions, before vs. after
2. Extend to $2 \times 2$ grid by gender (men: `sex=1`, women: `sex=2`)
3. Interpret: Evidence of shifts in violence? Different by gender?

```{r q2-density-plots-simple}
# Setup
density_plot <- data_subset %>% 
  mutate(
    period = factor(after, levels = c(0, 1), labels = c("Before (1991-93)", "After (1996-98)")),
    region_type = factor(grow, levels = c(0, 1), labels = c("Non-Growing Region", "Growing Region")),
    gender = factor(sex, levels = c(1, 2), labels = c("Men", "Women"))
  )


# Density plots: Non-growing vs. Growing regions
density_plot %>%
  ggplot(aes(x = outcome, fill = period, color = period)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ region_type) +
  labs(title = "Logged per-capita violent death rate distribution: Before vs After by Region Type",
       x = "Number of Violent Deaths",
       y = "Density") +
  theme_minimal()

```

```{r q2-density-plots-gender}
# 2x2 grid: Top=men, Bottom=women; Left=non-growing, Right=growing
density_plot %>%
  filter(!is.na(gender)) %>%
  ggplot(aes(x = outcome, fill = period, color = period)) +
  geom_density(alpha = 0.5) +
  facet_grid(gender ~ region_type) +
  labs(title = "Logged per-capita violent death rate distribution by Gender and Region Type",
       x = "Number of Violent Deaths",
       y = "Density") +
  theme_minimal()
```

**Interpretation:**

[Your interpretation here]

---

# Q3. Age-Specific Effects

**Task:** For coca-growing regions only, plot the change in outcome (after - before) by age group.

```{r q3-age-effects}
# Calculate mean difference by age for growing regions only


# Plot age-specific effects

```

**Interpretation:**

[Does the effect vary by age?]

---

# Q4. Testing the Parallel Trends Assumption (Pre-Treatment)

**Tasks:**

1. Use pre-treatment years (1990-1993)
2. Estimate: outcome $= \alpha + \beta \cdot \text{year} + \gamma \cdot \text{grow} + \delta \cdot (\text{grow} \times \text{year}) + u$
3. Test if `grow` $\times$ `year` interactions are jointly zero (year as linear and categorical)
4. Create graph of average outcome by year and group

```{r q4-prepare-data}
# Subset to pre-treatment years (1990-1993)

```

```{r q4-parallel-trends-linear}
# Model with year as linear

```

```{r q4-parallel-trends-categorical}
# Model with year as categorical (factor)

```

```{r q4-joint-test}
# Test if grow√óyear interactions are jointly zero

```

```{r q4-visual-trends}
# Graph: Average outcome by year and group

```

**Interpretation:**

[What do the p-values tell us about parallel trends?]

---

# Q5. Placebo DiD Test 

**Tasks:**

1. Create `placebo_after` (1 if year $= 1992$ or $1993$, 0 if year $= 1990$ or $1991$)
2. Estimate placebo DiD model
3. Interpret `placebo_after` $\times$ `grow` coefficient

```{r q5-placebo-data}
# Subset and create placebo variables

```

```{r q5-placebo-regression}
# Estimate placebo DiD model

```

**Interpretation:**

[Should the placebo effect be significant? What would significance suggest?]

---

# Q6. Covariate Balance at Time 0

**Task:** Compare treatment and control regions on `age`, `sex`, and `populati` using pre-treatment data.

```{r q6-balance-table}
# Create balance table

```

```{r q6-balance-plot}
# Optional: Standardized difference plot

```

**Discussion:**

[Why is covariate balance critical? What would imbalance imply?]

---

# Q7. Why Covariate Balance Matters

**Discussion Questions:**

1. If covariates are balanced at time 0, what does this imply about confounding?
2. What role do these variables play after assignment?
3. If violence trends already differ before treatment, how might this bias DiD?

[Your answers here]

---

# Q8. Covariate Timing and Post-Treatment Bias

**Discussion Questions:**

1. Should we include covariates from time 0, time 1, or both?
2. What happens if you include a covariate measured after treatment?
3. When might adjusting for post-treatment variables be appropriate?

[Your answers here]

---

# Q9. Computing the DiD Estimate

**Task:** Compute manual DiD estimate.

```{r q9-manual-did}
# Mean difference (after - before) for grow=1


# Mean difference (after - before) for grow=0


# DiD estimate: subtract the two

```

**Interpretation:**

[Why is DiD preferable to simple before-after comparison?]

---

# Q10. Regression Form of DiD

**Tasks:**

1. Estimate: outcome $= \beta_0 + \beta_1 \cdot \text{after} + \beta_2 \cdot \text{grow} + \beta_3 \cdot (\text{after} \times \text{grow}) + u$
2. Report $\beta_3$ and p-value
3. Show analytically that $\beta_3$ equals the manual DiD estimate

```{r q10-did-regression}
# DiD regression model

```

**Interpretation:**

[What does $\beta_3$ tell us about the causal effect?]

**Analytical proof:**

[Show that $\beta_3 = (\bar{Y}_{1,1} - \bar{Y}_{1,0}) - (\bar{Y}_{0,1} - \bar{Y}_{0,0})$]

---

# Q11. Adding Covariates

**Task:** Estimate three models and compare.

```{r q11-model1}
# Model 1: outcome ~ grow + after + growafter

```

```{r q11-model2}
# Model 2: Add age and sex

```

```{r q11-model3}
# Model 3: Add age, sex, and populati

```

```{r q11-comparison}
# Compare models

```

**Discussion:**

[Does $\beta_3$ change? Do covariates matter? Which specification is most credible?]

---

# Q12. Interpretation and Reflection

**Summary:**

1. Did violence increase or decrease after the air-bridge disruption?
2. Does the evidence support a "resource-curse" interpretation?
3. What are the remaining identification threats?

[Your final interpretation here]
